<h1>掲示板アプリ</h1>

<!-- 検索フォームエリア -->
<div class="bg-white p-4 rounded-lg shadow mb-6 border border-gray-100">
  <p class="text-gray-500 text-sm mb-2">投稿を検索</p>
  
  <%# search_form_for という専用のヘルパーを使います %>
  <%= search_form_for @q, url: root_path, class: "flex gap-2" do |f| %>
    
    <%# content_cont と書くと「contentカラムの中に(cont)含まれる」という検索になる %>
    <%= f.search_field :content_cont, placeholder: "キーワードを入力...", class: "border p-2 rounded w-full" %>
    
    <%= f.submit "検索", class: "bg-gray-700 text-white px-4 py-2 rounded hover:bg-gray-600 cursor-pointer" %>
    
  <% end %>
</div>

<!-- タブ切り替えエリア -->
<div class="flex border-b border-gray-200 mb-6">
  <%# 「すべて」タブ %>
  <%# params[:type] が空なら、こっちをアクティブ（黒字・下線）にする %>
  <%= link_to "すべての投稿", root_path, 
      class: "flex-1 text-center py-3 #{params[:type].nil? ? 'border-b-2 border-blue-500 font-bold text-blue-600' : 'text-gray-500 hover:text-gray-700'}" %>

  <%# 「フォロー中」タブ（ログイン時のみ表示） %>
  <% if user_signed_in? %>
    <%# params[:type] が 'following' なら、こっちをアクティブにする %>
    <%= link_to "フォロー中", root_path(type: "following"), 
        class: "flex-1 text-center py-3 #{params[:type] == 'following' ? 'border-b-2 border-blue-500 font-bold text-blue-600' : 'text-gray-500 hover:text-gray-700'}" %>
  <% end %>
</div>

<!-- 新規投稿フォーム -->
<div style="background-color: #f0f0f0; padding: 15px; margin-bottom: 20px;">
  <h3>新規投稿</h3>

<!-- フォーム全体を囲むdivに data-controller をつける -->
<!-- これで character_count_controller.js がこのエリアを監視します -->
<div data-controller="character-count">

  <%= render 'form', post: @post %>

<hr>

<h2>投稿一覧</h2>

<!-- grid-cols-1 (スマホは1列) / md:grid-cols-2 (タブレット以上は2列) / gap-6 (隙間を空ける) -->
<div class="grid grid-cols-1 md:grid-cols-2 gap-6">
  <%# @posts という配列から、1つずつ post に入れて繰り返す %>
  <% @posts.each do |post| %>
    <!-- カード自体の幅指定などは削除して、親のグリッドに任せます -->
    <div class="bg-white shadow rounded-lg p-6 border border-gray-100 h-full flex flex-col justify-between">

      <div class="mb-2">
        <%# 1. 投稿内容（クリックで詳細へ） %>
        <%= link_to post_path(post), class: "hover:opacity-70" do %>
          <p class="text-lg font-bold text-gray-800"><%= post.content %></p>
        <% end %>

        <!-- 画像があれば表示 -->
        <% if post.image.attached? %>
          <div class="mt-3">
            <%# image_tag で画像を表示。サイズ指定をしてはみ出し防止 %>
            <%= image_tag post.image, class: "rounded-lg max-h-60 object-cover" %>
          </div>
        <% end %>
        
        <div class="text-sm text-gray-500 flex gap-3 mt-2">
          <%# 2. 投稿者情報 %>
          <!-- <span>投稿者: <%= post.user&.email || "退会済みユーザー" %></span> -->

          <!-- 変更後：link_to で囲む -->
          <div class="flex items-center gap-2 font-medium text-gray-600">
            
            <% if post.user %>
              <!-- ユーザーがいる場合：アイコン + 名前リンク -->
              <%# さっき作ったヘルパーを使って画像を表示（サイズは小さめの25px） %>
              <%= user_avatar(post.user, size: 25) %>
              
              <%= link_to post.user.email, user_path(post.user), class: "hover:text-blue-500 hover:underline" %>
            
            <% else %>
              <!-- ユーザーがいない（退会済み）場合 -->
              <span>👤 退会済みユーザー</span>
            <% end %>
          </div>
          <%# 3. 投稿日 %>
          <span><%= post.created_at.strftime("%Y/%m/%d %H:%M") %></span>
        </div>
      </div>

  <!-- ここからボタンエリア：flex と justify-between で左右に配置 -->
  <div class="flex justify-between items-center mt-4 pt-2 border-t border-gray-100">

  <!-- 左側：いいねボタンエリア -->
    <div>
      <% if user_signed_in? %>
        <!-- ログイン中ならボタンを表示 -->
        <%= render 'likes/btn', post: post %>
      <% else %>
        <!-- ログアウト中はハートの数だけ表示 -->
        <span class="text-gray-400">♡ <%= post.likes.size %></span>
      <% end %>
    </div>
      
      <%# ログインしていて、かつ、投稿者本人である場合のみ表示 %>
    <% if user_signed_in? && current_user.id == post.user_id %>
      <div class="flex gap-2">
        <%= link_to "編集", edit_post_path(post), class: "text-blue-500 hover:text-blue-700 underline" %>
        
        <%= link_to "削除", post_path(post), 
            data: { turbo_method: :delete, turbo_confirm: "本当に削除しますか？" }, 
            class: "text-red-500 hover:text-red-700 underline" %>
      </div>
    <% end %>
  </div>
</div>
<% end %>
</div>

<!-- ページ送りボタン -->
<div class="mt-4 flex justify-center pb-10">
  <%= paginate @posts %>
</div>