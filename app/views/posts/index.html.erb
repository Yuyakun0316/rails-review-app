<h1>掲示板アプリ</h1>

<!-- 検索フォームエリア -->
<div class="bg-white p-4 rounded-lg shadow mb-6 border border-gray-100">
  <p class="text-gray-500 text-sm mb-2">投稿を検索</p>
  
  <%# search_form_for という専用のヘルパーを使います %>
  <%= search_form_for @q, url: root_path, class: "flex gap-2" do |f| %>
    
    <%# content_cont と書くと「contentカラムの中に(cont)含まれる」という検索になる %>
    <%= f.search_field :content_cont, placeholder: "キーワードを入力...", class: "border p-2 rounded w-full" %>
    
    <%= f.submit "検索", class: "bg-gray-700 text-white px-4 py-2 rounded hover:bg-gray-600 cursor-pointer" %>
    
  <% end %>
</div>

<!-- 新規投稿フォーム -->
<div style="background-color: #f0f0f0; padding: 15px; margin-bottom: 20px;">
  <h3>新規投稿</h3>

<!-- フォーム全体を囲むdivに data-controller をつける -->
<!-- これで character_count_controller.js がこのエリアを監視します -->
<div data-controller="character-count">

  <%# model: @post と書くことで、Postモデル用のフォームだとRailsが判断してくれる %>
  <%= form_with model: @post, url: posts_path, local: true do |f| %>
    
    <div class="mb-2">
      <%# 入力欄（ターゲット）: data-character-count-target="input" %>
      <%# 入力するたびに動くアクション: data-action="input->character-count#count" %>
      <%= f.text_area :content, 
          class: "w-full border p-2 rounded", 
          placeholder: "ここに入力してね",
          rows: 3,
          data: { 
            character_count_target: "input", 
            action: "input->character-count#count" 
          } %>
      <!-- ファイル選択ボタン -->
      <div class="mt-2">
        <%= f.file_field :image, class: "text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" %>
      </div>
    </div>

    <!-- 文字数を表示する場所（ターゲット） -->
    <div class="text-right text-sm text-gray-500 mb-2">
      あと <span data-character-count-target="output">140</span> 文字
    </div>
    
    <%= f.submit "投稿する", class: "bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded" %>
    
  <% end %>
</div>

<hr>

<h2>投稿一覧</h2>

<%# @posts という配列から、1つずつ post に入れて繰り返す %>
<% @posts.each do |post| %>

    <div class="bg-white shadow rounded-lg p-6 mb-4 border border-gray-100">
      <div class="mb-2">
        <%# 1. 投稿内容（クリックで詳細へ） %>
        <%= link_to post_path(post), class: "hover:opacity-70" do %>
          <p class="text-lg font-bold text-gray-800"><%= post.content %></p>
        <% end %>

        <!-- 画像があれば表示 -->
        <% if post.image.attached? %>
          <div class="mt-3">
            <%# image_tag で画像を表示。サイズ指定をしてはみ出し防止 %>
            <%= image_tag post.image, class: "rounded-lg max-h-60 object-cover" %>
          </div>
        <% end %>
        
        <div class="text-sm text-gray-500 flex gap-3 mt-2">
          <%# 2. 投稿者情報 %>
          <!-- <span>投稿者: <%= post.user&.email || "退会済みユーザー" %></span> -->

          <!-- 変更後：link_to で囲む -->
          <span class="font-medium text-gray-600">
            👤 
            <% if post.user %>
              <%= link_to post.user.email, user_path(post.user), class: "hover:text-blue-500 hover:underline" %>
            <% else %>
              退会済みユーザー
            <% end %>
          </span>
          <%# 3. 投稿日 %>
          <span><%= post.created_at.strftime("%Y/%m/%d %H:%M") %></span>
        </div>
      </div>

  <!-- ここからボタンエリア：flex と justify-between で左右に配置 -->
  <div class="flex justify-between items-center mt-4 pt-2 border-t border-gray-100">

  <!-- 左側：いいねボタンエリア -->
    <div>
      <% if user_signed_in? %>
        <!-- ログイン中ならボタンを表示 -->
        <%= render 'likes/btn', post: post %>
      <% else %>
        <!-- ログアウト中はハートの数だけ表示 -->
        <span class="text-gray-400">♡ <%= post.likes.count %></span>
      <% end %>
    </div>
      
      <%# ログインしていて、かつ、投稿者本人である場合のみ表示 %>
    <% if user_signed_in? && current_user.id == post.user_id %>
      <div class="flex gap-2">
        <%= link_to "編集", edit_post_path(post), class: "text-blue-500 hover:text-blue-700 underline" %>
        
        <%= link_to "削除", post_path(post), 
            data: { turbo_method: :delete, turbo_confirm: "本当に削除しますか？" }, 
            class: "text-red-500 hover:text-red-700 underline" %>
      </div>
    <% end %>
  </div>
</div>
<% end %>

<!-- ページ送りボタン -->
<div class="mt-4 flex justify-center pb-10">
  <%= paginate @posts %>
</div>